# 云文件管理系统 - 系统流程图

## 1. 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户浏览器                                       │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼ HTTP (:80)
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Nginx 反向代理                                      │
│  ┌─────────────────────┐    ┌─────────────────────────────────────────┐     │
│  │  静态文件 (/)        │    │  API 代理 (/api/*)                       │     │
│  │  Vue3 SPA           │    │  → http://backend:8919                  │     │
│  └─────────────────────┘    └─────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼ HTTP (:8919)
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Spring Boot 后端服务                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ UserController│  │FileController│  │ShareController│  │TrashController│    │
│  │   用户认证    │  │   文件管理   │  │   文件分享    │  │   回收站      │     │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘     │
│                              │                                               │
│  ┌───────────────────────────┴───────────────────────────┐                  │
│  │                     Service 业务层                      │                  │
│  │  FileService | UserService | ShareService | RedisService                 │
│  └───────────────────────────────────────────────────────┘                  │
│                              │                                               │
│  ┌───────────────────────────┴───────────────────────────┐                  │
│  │                     Mapper 数据层                       │                  │
│  │              MyBatis-Plus + MySQL Driver               │                  │
│  └───────────────────────────────────────────────────────┘                  │
└─────────────────────────────────────────────────────────────────────────────┘
           │                                           │
           ▼ (:3306)                                   ▼ (:6379)
┌─────────────────────┐                    ┌─────────────────────┐
│       MySQL         │                    │       Redis         │
│  用户表 | 文件表     │                    │  Token缓存 | 分片缓存│
│  分享表 | 回收站表   │                    │                     │
└─────────────────────┘                    └─────────────────────┘
```

---

## 2. 用户登录流程

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│  用户    │     │  前端    │     │  后端    │     │  数据库  │     │  Redis   │
└────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │                │                │                │                │
     │ 输入账号密码    │                │                │                │
     │───────────────>│                │                │                │
     │                │                │                │                │
     │                │ POST /user/login               │                │
     │                │───────────────>│                │                │
     │                │                │                │                │
     │                │                │ 查询用户       │                │
     │                │                │───────────────>│                │
     │                │                │                │                │
     │                │                │ 返回用户信息   │                │
     │                │                │<───────────────│                │
     │                │                │                │                │
     │                │                │ 验证密码(MD5)  │                │
     │                │                │────────┐       │                │
     │                │                │        │       │                │
     │                │                │<───────┘       │                │
     │                │                │                │                │
     │                │                │ 生成JWT Token  │                │
     │                │                │────────┐       │                │
     │                │                │        │       │                │
     │                │                │<───────┘       │                │
     │                │                │                │                │
     │                │ 返回Token+用户信息             │                │
     │                │<───────────────│                │                │
     │                │                │                │                │
     │                │ 存储Token到localStorage         │                │
     │                │────────┐       │                │                │
     │                │        │       │                │                │
     │                │<───────┘       │                │                │
     │                │                │                │                │
     │ 登录成功,跳转首页               │                │                │
     │<───────────────│                │                │                │
     │                │                │                │                │
```

---

## 3. 文件上传流程（分片上传 + 秒传）

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│  用户    │     │  前端    │     │  后端    │     │  Redis   │     │  磁盘    │
└────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │                │                │                │                │
     │ 选择文件       │                │                │                │
     │───────────────>│                │                │                │
     │                │                │                │                │
     │                │ 计算文件MD5    │                │                │
     │                │────────┐       │                │                │
     │                │        │       │                │                │
     │                │<───────┘       │                │                │
     │                │                │                │                │
     │                │ POST /file/uploadInit (MD5)    │                │
     │                │───────────────>│                │                │
     │                │                │                │                │
     │                │                │ 查询MD5是否存在│                │
     │                │                │───────────────>│                │
     │                │                │                │                │
     │                │                │<───────────────│                │
     │                │                │                │                │
     │                ├────────────────┴────────────────┤                │
     │                │         【分支判断】             │                │
     │                ├─────────────────────────────────┤                │
     │                │                │                │                │
     │   ┌────────────┴────────────┐   │                │                │
     │   │ 情况A: MD5已存在(秒传)   │   │                │                │
     │   └────────────┬────────────┘   │                │                │
     │                │                │                │                │
     │                │ 返回 uploaded=true              │                │
     │                │<───────────────│                │                │
     │                │                │                │                │
     │ 秒传成功！      │                │                │                │
     │<───────────────│                │                │                │
     │                │                │                │                │
     │   ┌────────────┴────────────┐   │                │                │
     │   │ 情况B: 需要上传          │   │                │                │
     │   └────────────┬────────────┘   │                │                │
     │                │                │                │                │
     │                │ 返回 uploaded=false + 已上传分片列表             │
     │                │<───────────────│                │                │
     │                │                │                │                │
     │                │ 文件切片(每片5MB)               │                │
     │                │────────┐       │                │                │
     │                │        │       │                │                │
     │                │<───────┘       │                │                │
     │                │                │                │                │
     │                │ ┌─────────────────────────────────────────────┐  │
     │                │ │ 循环上传每个分片                              │  │
     │                │ │ POST /file/upload (chunkNumber, chunkData)  │  │
     │                │ │─────────────>│                │              │  │
     │                │ │              │                │              │  │
     │                │ │              │ 保存分片       │              │  │
     │                │ │              │───────────────────────────────>│  │
     │                │ │              │                │              │  │
     │                │ │              │ 记录分片状态   │              │  │
     │                │ │              │───────────────>│              │  │
     │                │ │              │                │              │  │
     │                │ │ 返回成功     │                │              │  │
     │                │ │<─────────────│                │              │  │
     │                │ └─────────────────────────────────────────────┘  │
     │                │                │                │                │
     │                │ 最后一片上传完成                │                │
     │                │───────────────>│                │                │
     │                │                │                │                │
     │                │                │ 合并所有分片   │                │
     │                │                │───────────────────────────────>│
     │                │                │                │                │
     │                │                │ 生成缩略图     │                │
     │                │                │────────┐       │                │
     │                │                │        │       │                │
     │                │                │<───────┘       │                │
     │                │                │                │                │
     │                │ 返回文件ID     │                │                │
     │                │<───────────────│                │                │
     │                │                │                │                │
     │ 上传完成！      │                │                │                │
     │<───────────────│                │                │                │
```

---

## 4. 文件分享流程

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│ 分享者   │     │  后端    │     │  数据库  │     │ 访问者   │
└────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │                │                │                │
     │ POST /share/create             │                │
     │ (fileId, expireDays)           │                │
     │───────────────>│                │                │
     │                │                │                │
     │                │ 生成分享码(8位随机)             │
     │                │────────┐       │                │
     │                │        │       │                │
     │                │<───────┘       │                │
     │                │                │                │
     │                │ 保存分享记录   │                │
     │                │───────────────>│                │
     │                │                │                │
     │ 返回分享链接   │                │                │
     │ /s/abc12345    │                │                │
     │<───────────────│                │                │
     │                │                │                │
     │                │                │                │
     │================│================│================│
     │                │                │                │
     │                │                │ 访问分享链接   │
     │                │                │ GET /share/access/abc12345
     │                │                │<───────────────│
     │                │                │                │
     │                │ 查询分享记录   │                │
     │                │<───────────────│                │
     │                │                │                │
     │                │ 检查是否过期   │                │
     │                │────────┐       │                │
     │                │        │       │                │
     │                │<───────┘       │                │
     │                │                │                │
     │                │ 查询文件信息   │                │
     │                │───────────────>│                │
     │                │                │                │
     │                │                │ 返回文件信息   │
     │                │                │───────────────>│
     │                │                │                │
     │                │                │ 下载/预览文件  │
     │                │                │<───────────────│
```

---

## 5. 文件回收站流程

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│  用户    │     │  后端    │     │  数据库  │     │  磁盘    │
└────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │                │                │                │
     │ 删除文件       │                │                │
     │ POST /file/delete              │                │
     │───────────────>│                │                │
     │                │                │                │
     │                │ 标记文件 in_trash=1             │
     │                │───────────────>│                │
     │                │                │                │
     │                │ 创建回收站记录 │                │
     │                │───────────────>│                │
     │                │                │                │
     │ 删除成功(移入回收站)            │                │
     │<───────────────│                │                │
     │                │                │                │
     │================│================│================│
     │                │                │                │
     │ 还原文件       │                │                │
     │ POST /trash/restore            │                │
     │───────────────>│                │                │
     │                │                │                │
     │                │ 标记文件 in_trash=0             │
     │                │───────────────>│                │
     │                │                │                │
     │                │ 删除回收站记录 │                │
     │                │───────────────>│                │
     │                │                │                │
     │ 还原成功       │                │                │
     │<───────────────│                │                │
     │                │                │                │
     │================│================│================│
     │                │                │                │
     │ 彻底删除       │                │                │
     │ POST /trash/delete             │                │
     │───────────────>│                │                │
     │                │                │                │
     │                │ 删除数据库记录 │                │
     │                │───────────────>│                │
     │                │                │                │
     │                │ 删除物理文件   │                │
     │                │───────────────────────────────>│
     │                │                │                │
     │ 彻底删除成功   │                │                │
     │<───────────────│                │                │
     │                │                │                │
     │================│================│================│
     │                │                │                │
     │ 清空回收站     │                │                │
     │ POST /trash/clear              │                │
     │───────────────>│                │                │
     │                │                │                │
     │                │ 批量删除所有回收站记录          │
     │                │───────────────>│                │
     │                │                │                │
     │                │ 批量删除物理文件                │
     │                │───────────────────────────────>│
     │                │                │                │
     │ 清空成功       │                │                │
     │<───────────────│                │                │
```

---

## 6. 数据库 ER 图

```
┌─────────────────────┐       ┌─────────────────────┐
│     sys_user        │       │      lfs_file       │
├─────────────────────┤       ├─────────────────────┤
│ id (PK)             │       │ id (PK)             │
│ username            │       │ user_id (FK)────────┼──┐
│ password (MD5)      │       │ dir_id              │  │
│ nickname            │       │ name                │  │
│ avatar              │       │ file_type           │  │
│ create_time         │       │ file_size           │  │
└─────────────────────┘       │ md5                 │  │
         │                    │ path                │  │
         │                    │ in_trash            │  │
         │                    │ create_time         │  │
         │                    └─────────────────────┘  │
         │                             │               │
         │                             │               │
         ▼                             ▼               │
┌─────────────────────┐       ┌─────────────────────┐  │
│   lfs_file_share    │       │   lfs_file_trash    │  │
├─────────────────────┤       ├─────────────────────┤  │
│ id (PK)             │       │ id (PK)             │  │
│ file_id (FK)────────┼───────│ file_id (FK)────────┼──┤
│ user_id (FK)────────┼───┐   │ user_id (FK)────────┼──┤
│ share_code          │   │   │ delete_time         │  │
│ expire_time         │   │   │ original_path       │  │
│ create_time         │   │   └─────────────────────┘  │
└─────────────────────┘   │                            │
                          │                            │
                          └────────────────────────────┘
```

---

## 7. 前端页面结构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              App.vue (根组件)                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         Login.vue (登录页)                           │   │
│  │  ┌─────────────────┐  ┌─────────────────┐                           │   │
│  │  │   登录表单       │  │   注册表单       │                           │   │
│  │  └─────────────────┘  └─────────────────┘                           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         Index.vue (主页面)                           │   │
│  │  ┌──────────────────────────────────────────────────────────────┐   │   │
│  │  │                    BaseHeader.vue (顶部导航)                   │   │   │
│  │  │  [Logo] [搜索框] [上传按钮] [用户头像] [退出]                   │   │   │
│  │  └──────────────────────────────────────────────────────────────┘   │   │
│  │  ┌────────────┐  ┌──────────────────────────────────────────────┐   │   │
│  │  │ BaseSide   │  │                 file.vue (文件列表)           │   │   │
│  │  │ (侧边栏)   │  │  ┌─────────────────────────────────────────┐  │   │   │
│  │  │            │  │  │ 面包屑导航: 全部文件 > 文档 > ...        │  │   │   │
│  │  │ [全部文件] │  │  └─────────────────────────────────────────┘  │   │   │
│  │  │ [图片]     │  │  ┌─────────────────────────────────────────┐  │   │   │
│  │  │ [视频]     │  │  │ 工具栏: [新建文件夹] [视图切换] [排序]   │  │   │   │
│  │  │ [文档]     │  │  └─────────────────────────────────────────┘  │   │   │
│  │  │ [音频]     │  │  ┌─────────────────────────────────────────┐  │   │   │
│  │  │ [其他]     │  │  │                                         │  │   │   │
│  │  │ [回收站]   │  │  │  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐       │  │   │   │
│  │  │            │  │  │  │文件1│ │文件2│ │文件3│ │文件4│       │  │   │   │
│  │  │ ─────────  │  │  │  └─────┘ └─────┘ └─────┘ └─────┘       │  │   │   │
│  │  │ 存储空间   │  │  │  ┌─────┐ ┌─────┐ ┌─────┐               │  │   │   │
│  │  │ [████░░]   │  │  │  │文件5│ │文件6│ │文件7│               │  │   │   │
│  │  │ 2.5G/10G   │  │  │  └─────┘ └─────┘ └─────┘               │  │   │   │
│  │  │            │  │  │                                         │  │   │   │
│  │  └────────────┘  │  └─────────────────────────────────────────┘  │   │   │
│  │                  └──────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    预览组件 (弹窗/新页面)                             │   │
│  │  ImagePreview.vue | VideoPreview.vue | PdfPreview.vue | AudioPreview│   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. 技术栈总结

| 层次 | 技术 | 说明 |
|------|------|------|
| 前端框架 | Vue 3 + Vite | 响应式框架 + 构建工具 |
| UI组件库 | Element Plus | 企业级组件库 |
| 状态管理 | Composition API | Vue3 组合式 API |
| 后端框架 | Spring Boot 2.x | Java 后端框架 |
| ORM框架 | MyBatis-Plus | 增强版 MyBatis |
| 认证方式 | JWT | 无状态 Token 认证 |
| 数据库 | MySQL 8.0 | 关系型数据库 |
| 缓存 | Redis | 分片信息缓存 |
| 反向代理 | Nginx | 静态资源 + API 代理 |
| 容器化 | Docker Compose | 一键部署 |
